rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       Helper functions
       ========================= */

    function isSignedIn() {
      return request.auth != null;
    }

    // Validates that the participants field is a non-empty list
    // and that a user isn't creating a chat with only themselves.
    function isValidParticipants(data) {
      return data.participants is list
        && data.participants.size() > 0;
    }

    // Checks if the requesting user is a member of the chat.
    function isParticipant(data) {
      return isSignedIn()
        && data.participants is list
        && request.auth.uid in data.participants;
    }

    // Ensures the participants list is not modified after creation.
    function unchangedParticipants() {
      return request.resource.data.participants == resource.data.participants;
    }

    /* =========================
       Users collection
       ========================= */
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && request.auth.uid == userId;
      allow delete: if false; 
    }

    /* =========================
       Chats collection
       ========================= */

    match /chats/{chatId} {

      // READ (get + list)
      // Allow if the user is a participant. This works for 'array-contains' queries.
      allow read: if isParticipant(resource.data) || (isSignedIn() && request.auth.uid in request.query.where.participants);

      // CREATE
      // Allow if user is signed in, participants list is valid, and creator is a participant.
      allow create: if isSignedIn()
        && isValidParticipants(request.resource.data)
        && request.auth.uid in request.resource.data.participants
        && request.resource.data.createdAt is timestamp;

      // UPDATE
      // Allow if user is a participant and the participants list is not being changed.
      allow update: if isParticipant(resource.data)
        && unchangedParticipants();

      // DELETE (blocked)
      allow delete: if false;
    }

    /* =========================
       Messages subcollection
       ========================= */

    match /chats/{chatId}/messages/{messageId} {

      // Allow read if user is a participant of the parent chat.
      allow read: if isSignedIn()
        && isParticipant(
          get(/databases/$(database)/documents/chats/$(chatId)).data
        );

      // Allow create if user is a participant, the senderId is correct, and data is valid.
      allow create: if isSignedIn()
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.text is string
        && request.resource.data.timestamp is timestamp
        && isParticipant(
          get(/databases/$(database)/documents/chats/$(chatId)).data
        );

      // No edits or deletes to prevent message tampering.
      allow update, delete: if false;
    }
  }
}
