{
  "entities": {
    "Session": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Session",
      "type": "object",
      "description": "Represents a user's session, used for identifying users anonymously.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the session."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the session was created.",
          "format": "date-time"
        },
        "expiryTime": {
          "type": "string",
          "description": "Timestamp indicating when the session expires.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "createdAt",
        "expiryTime"
      ]
    },
    "Message": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Message",
      "type": "object",
      "description": "Represents a single chat message.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the message."
        },
        "senderId": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N Message)  ID of the user who sent the message."
        },
        "receiverId": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N Message) ID of the user who should receive the message."
        },
        "content": {
          "type": "string",
          "description": "The encrypted content of the message."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp indicating when the message was sent.",
          "format": "date-time"
        },
        "isRead": {
          "type": "boolean",
          "description": "Indicates if the message has been read by the recipient."
        }
      },
      "required": [
        "id",
        "senderId",
        "receiverId",
        "content",
        "timestamp",
        "isRead"
      ]
    },
    "ChatRoom": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatRoom",
      "type": "object",
      "description": "Represents a chat room between two users.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the chat room."
        },
        "user1Id": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N ChatRoom) ID of the first user in the chat room."
        },
        "user2Id": {
          "type": "string",
          "description": "Reference to Session. (Relationship: Session 1:N ChatRoom) ID of the second user in the chat room."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the chat room was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "user1Id",
        "user2Id",
        "createdAt"
      ]
    },
    "InviteLink": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "InviteLink",
      "type": "object",
      "description": "Represents a one-time use invite link for joining a chat.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the invite link."
        },
        "creatorId": {
          "type": "string",
          "description": "Reference to Session. ID of the user who created the invite link."
        },
        "chatRoomId": {
          "type": "string",
          "description": "Reference to ChatRoom. ID of the chat room this link is associated with."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the invite link was created.",
          "format": "date-time"
        },
        "expiresAt": {
          "type": "string",
          "description": "Timestamp indicating when the invite link expires.",
          "format": "date-time"
        },
        "used": {
          "type": "boolean",
          "description": "Indicates if the invite link has been used."
        }
      },
      "required": [
        "id",
        "creatorId",
        "chatRoomId",
        "createdAt",
        "expiresAt",
        "used"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/chatRooms/{chatRoomId}",
        "definition": {
          "entityName": "ChatRoom",
          "schema": {
            "$ref": "#/backend/entities/ChatRoom"
          },
          "description": "Stores chat room metadata. Chat rooms are created via invite links.",
          "params": [
            {
              "name": "chatRoomId",
              "description": "Unique identifier for the chat room."
            }
          ]
        }
      },
      {
        "path": "/messages/{messageId}",
        "definition": {
          "entityName": "Message",
          "schema": {
            "$ref": "#/backend/entities/Message"
          },
          "description": "Stores chat messages. Includes `senderId`, `receiverId` and denormalized `chatRoomId` for authorization independence.",
          "params": [
            {
              "name": "messageId",
              "description": "Unique identifier for the message."
            }
          ]
        }
      },
      {
        "path": "/inviteLinks/{inviteLinkId}",
        "definition": {
          "entityName": "InviteLink",
          "schema": {
            "$ref": "#/backend/entities/InviteLink"
          },
          "description": "Stores invite link data. Includes `creatorId` for authorization.",
          "params": [
            {
              "name": "inviteLinkId",
              "description": "Unique identifier for the invite link."
            }
          ]
        }
      },
      {
        "path": "/sessions/{sessionId}",
        "definition": {
          "entityName": "Session",
          "schema": {
            "$ref": "#/backend/entities/Session"
          },
          "description": "Stores session data, used as an anonymous identifier.",
          "params": [
            {
              "name": "sessionId",
              "description": "Unique identifier for the session."
            }
          ]
        }
      }
    ],
    "reasoning": "This design prioritizes anonymity and ephemeral messaging.  It uses separate collections for chat rooms and messages, with denormalization to ensure authorization independence. Invite links are managed in their own collection, ensuring they are one-time use. Since no user accounts exist, session IDs are treated as user identifiers for security rule purposes. This structure facilitates secure `list` operations and atomic operations through Authorization Independence.\n\nAuthorization Independence is achieved by:\n1.  Storing chat room IDs in each message document. This enables direct access to messages given a chat room, without needing to query or 'get()' the parent chat room document.\n2.  InviteLink documents explicitly store the `creatorId` to allow restricting invite link creation and usage.\n\nQAPs:\n1.  The use of distinct collections (`chatRooms`, `messages`, `inviteLinks`) enables straightforward security rules for each data type.\n2.  Authorization is determined by the `senderId`, `receiverId` and `chatRoomId` of `messages` allowing for secure `list` operations on messages for a given chat room and participants."
  }
}